{% extends "base.html" %}

{% block nav_chat %}active{% endblock %}

{% block head %}
<link href="{{ url_for('static', path='/css/chat-style.css') }}" rel="stylesheet">
{% endblock %}

{% block title %}
<title>Chat</title>
{% endblock %}

{% block content %}

{% if dialogs %}
<section class="mt-3" style="background-color: #d1d1d1; border-radius: 10px;">
    <div class="d-flex flex-wrap justify-content-center align-items-center pt-3 pb-3">
  {% for dialog in dialogs %}
      <div class="col col-md-9 col-lg-7 col-xl-5">
        <div class="card mb-5" style="border-radius: 15px;">
          <div class="card-body p-4">
            <h3 class="mb-3">Dialog {{ dialog.creator.username }} - {{ dialog.interlocutor.username }}</h3>
            <p class="small mb-0">Created at {{ dialog.created_at }}</p>
            <hr class="my-4">
            <div class="d-flex pt-1">
              <a href="/front/pages/chat/{{ dialog.id }}" role="button" class="btn btn-outline-info me-1 flex-grow-1">View...</a>
            </div>
            <hr class="my-4">
            <div class="d-flex justify-content-start align-items-center">
              <div class="rounded-circle overflow-hidden" style="width: 35px; height: 35px;">
                <a href="/front/pages/user/{{ dialog.creator.id }}">
                  <img src="{{ url_for('static', path='/profileimages/' + dialog.creator.avatar_url) }}" alt="avatar"
                    style="object-fit: cover; width: 100%; height: 100%;" width="35" height="35">
                </a>
              </div>
              <div class="rounded-circle overflow-hidden" style="width: 35px; height: 35px;">
                <a href="/front/pages/user/{{ dialog.interlocutor.id }}">
                  <img src="{{ url_for('static', path='/profileimages/' + dialog.interlocutor.avatar_url) }}" alt="avatar"
                    style="object-fit: cover; width: 100%; height: 100%;" width="35" height="35">
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
  {% endfor %}
    </div>
  </section>
{% endif %}

{% if dialog %}
<div class="row container d-flex justify-content-center">
    <div class="col-md-6 mt-3">
        <div class="card card-bordered">
            <div class="card-header">
                <h4 class="card-title"><strong>Dialog {{ dialog.creator.username }} - {{ dialog.interlocutor.username }}</strong></h4>
                <a class="btn btn-xs btn-secondary" href="#" data-abc="true">Delete dialog</a>
            </div>

            <div class="ps-container ps-theme-default ps-active-y" id="chat-content" style="overflow-y: scroll !important; height:400px !important;">
                {% for msg in dialog.messages %}
                    {% if not msg.is_sender %}
                    <div class="media media-chat">
                        <img class="avatar" src="{{ url_for('static', path='/profileimages/' + msg.sender.avatar_url) }}" alt="...">
                        <div class="media-body">
                            <p>{{ msg.content }}</p>
                            <p class="meta"><time>{{ msg.send_at }}</time></p>
                        </div>
                    </div>
                    {% endif %}

                    {% if msg.is_sender %}
                    <div class="media media-chat media-chat-reverse">
                        <div class="media-body">
                            <p>{{ msg.content }}</p>
                            <p class="meta"><time>{{ msg.send_at }}</time></p>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
                <div class="ps-scrollbar-x-rail" style="left: 0px; bottom: 0px;">
                    <div class="ps-scrollbar-x" tabindex="0" style="left: 0px; width: 0px;"></div>
                </div>
                <div class="ps-scrollbar-y-rail" style="top: 0px; height: 0px; right: 2px;">
                    <div class="ps-scrollbar-y" tabindex="0" style="top: 0px; height: 2px;"></div>
                </div>
            </div>
            <div class="publisher bt-1 border-light">
                <img class="avatar avatar-xs" src="{{ url_for('static', path='/profileimages/' + user.avatar_url) }}" alt="...">
                <form style="width: 100%;" action="" onsubmit="sendMessage(event)">
                    <input id="messageText" autocomplete="off" class="publisher-input" type="text" placeholder="Message...">
                    <button type="submit" class="publisher-btn text-info"><i class="fa fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    let user_id = "{{ user.id }}";
    let dialog_id = "{{ dialog.id }}";
    let ws = new WebSocket(`ws://localhost:8000/api/v1/chat/ws/${dialog_id}/${user_id}`);
    ws.onmessage = function(event) {
        let messageBlock = document.createElement('div');
        messageBlock.classList.add('media', 'media-chat', 'media-chat-reverse');

        let mediaBody = document.createElement('div');
        mediaBody.classList.add('media-body');

        let contentParagraph = document.createElement('p');
        let content = document.createTextNode(event.data);
        contentParagraph.appendChild(content);

        let metaParagraph = document.createElement('p');
        metaParagraph.classList.add('meta');

        let timeElement = document.createElement('time');
        let formattedDateTime = new Date().toISOString().slice(0, 19).replace("T", " ");
        timeElement.textContent = formattedDateTime;

        metaParagraph.appendChild(timeElement);
        mediaBody.appendChild(contentParagraph);
        mediaBody.appendChild(metaParagraph);
        messageBlock.appendChild(mediaBody);

        let chatContainer = document.querySelector('#chat-content');
        chatContainer.appendChild(messageBlock);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        };

    function sendMessage(event) {
        let input = document.getElementById("messageText");
        ws.send(input.value);
        input.value = '';
        event.preventDefault();
    }
</script>
{% endif %}


{% endblock %}